<!DOCTYPE html>

<html lang="en" dir="ltr">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <title>Lights On!</title>

  </head>

  <body>

    <div>
     <!-- <img src="{{url_for('static', filename='menu.png')}}" alt="menu" id="menu-icon"> -->
      <p id="menu-title">WAITING</p>
      <p>You have been added to the queue. Your position is: {{ queue_pos }} of {{ max_queue }}</p>
      <button onclick="document.location='http://{{ self_ip }}:5000/addtoqueue'">Try Again</button>
      <br>
      <button onclick="document.location='http://{{ self_ip }}:5000/end'">End Session</button>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <!-- <script src="{{ url_for('static', filename='ledctrl.js') }}"></script> -->

    <script>
          
      // var ledctrl_socket = new WebSocket('ws://192.168.0.41:31415/ledctrl');
      var ledctrl_socket = new WebSocket('ws://{{ self_ip }}:31415/ledctrl');

      var user_uuid = '{{ user_uuid }}';
      var user_ip = '{{ user_ip }}';

      document.addEventListener('DOMContentLoaded', () => {
        // Connect to Socketio
        var flask_socket = io.connect('http://{{ self_ip }}:5000');

        // When connected
        flask_socket.on('connect', () => {
            console.log("Connecting to flask");
        });

        setInterval(() => {
          flask_socket.emit('wait', {'uuid':user_uuid});
        }, 1000);

        function wait_handler(data) {
          msg = JSON.parse(data);
          console.log(msg);
          if (msg.wait_result == true) {
            window.location.replace("http://{{ self_ip }}:5000/ledctrl");
          }
        }

        flask_socket.on('wait_result', wait_handler)
      });

    </script>

  </body>

</html>