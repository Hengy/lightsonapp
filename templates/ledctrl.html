<!DOCTYPE html>

<html lang="en" dir="ltr">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <title>Lights On!</title>

  </head>

  <body>

    <div>
     <!-- <img src="{{url_for('static', filename='menu.png')}}" alt="menu" id="menu-icon">  -->
      <p id="menu-title">LED CONTROL</p>
      <button id="idle-bttn">IDLE</button>
      <button id="LED-bttn">LED</button>
      <button id="dark-bttn">DARK</button>
    </div>

    <a href="http://{{ self_ip }}:5000/end">End Session</a>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <!-- <script src="{{ url_for('static', filename='ledctrl.js') }}"></script> -->

    <script>
          
      // var ledctrl_socket = new WebSocket('ws://192.168.0.41:31415/ledctrl');
      var ledctrl_socket = new WebSocket('ws://{{ self_ip }}:31415/ledctrl');

      var user_uuid = null;
      var user_ip = null;

      document.addEventListener('DOMContentLoaded', () => {
        // Connect to Socketio
        var flask_socket = io.connect('http://{{ self_ip }}:5000');

        // When connected
        flask_socket.on('connect', () => {
            console.log("Connecting to flask");
        });

        setInterval(() => {
          flask_socket.emit('check', {'message':'none'});
        }, 1000);

        function check_handler(data) {
          msg = JSON.parse(data);
          if (msg.check_result == true) {
            window.location.replace("http://{{ self_ip }}:5000/end");
          }
        }

        flask_socket.on('check_result', check_handler)
      });

      function getUserDetails(details) {
          user_uuid = details["uuid"];
          user_ip = details["ip"];
      }

      ledctrl_socket.onopen = function(event) {
        console.log('Connected.');
      };

      ledctrl_socket.onerror = function(error) {
        console.log('WebSocket error: ' + error);
      };

      $("#idle-bttn").click(function() {
          msg = {"CMD":"IDLE", "uuid":user_uuid, "IP":user_ip}
          ledctrl_socket.send(JSON.stringify(msg));
      });

      $("#LED-bttn").click(function() {
          msg = {"CMD":"LED", "uuid":user_uuid, "IP":user_ip}
          ledctrl_socket.send(JSON.stringify(msg));
      });

      $("#dark-bttn").click(function() {
          msg = {"CMD":"DARK", "uuid":user_uuid, "IP":user_ip}
          ledctrl_socket.send(JSON.stringify(msg));
      });

      window.onload = getUserDetails({{data|tojson}});

    </script>

  </body>

</html>